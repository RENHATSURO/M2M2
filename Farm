-- SERVICES
local Players = game:GetService("Players")
local PathfindingService = game:GetService("PathfindingService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- SETTINGS
local autoWalk = false
local moveMode = "Pathfinding" -- Pathfinding | Walk | Tween
local tweenSpeed = 20
local tpIfStuck = true

-- INTERNAL
local currentTaskId = 0
local humanoid, rootPart
local activeTween
local coinBlacklist = {} -- [Instance] = true
local cachedCoins = {}

-- ================= GUI =================

local gui = Instance.new("ScreenGui")
gui.Name = "AutoCoinGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.fromScale(0.35, 0.45)
frame.Position = UDim2.fromScale(0.03, 0.25)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.Active = true
frame.Draggable = true
frame.Parent = gui

local function newButton(text, y)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromScale(0.9, 0.08)
	b.Position = UDim2.fromScale(0.05, y)
	b.Text = text
	b.TextScaled = true
	b.BackgroundColor3 = Color3.fromRGB(60,60,60)
	b.Parent = frame
	return b
end

local toggleBtn = newButton("Auto Walk : OFF", 0.02)
local modeBtn   = newButton("Mode : Pathfinding", 0.12)

-- Tween slider label
local sliderLabel = Instance.new("TextLabel")
sliderLabel.Size = UDim2.fromScale(0.9, 0.06)
sliderLabel.Position = UDim2.fromScale(0.05, 0.22)
sliderLabel.Text = "Tween Speed : 20"
sliderLabel.TextScaled = true
sliderLabel.BackgroundTransparency = 0.8
sliderLabel.BorderSizePixel = 0
sliderLabel.BackgroundColor3 = Color3.fromRGB(25,25,25)
sliderLabel.TextColor3 = Color3.new(1,1,1)
sliderLabel.Parent = frame

-- Slider bar
local sliderBar = Instance.new("Frame")
sliderBar.Size = UDim2.fromScale(0.9, 0.03)
sliderBar.Position = UDim2.fromScale(0.05, 0.29)
sliderBar.BackgroundColor3 = Color3.fromRGB(80,80,80)
sliderBar.Parent = frame

local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.fromScale(0.3, 1)
sliderFill.BackgroundColor3 = Color3.fromRGB(0,170,255)
sliderFill.Parent = sliderBar

-- Coin list
local listLabel = Instance.new("TextLabel")
listLabel.Size = UDim2.fromScale(0.9, 0.06)
listLabel.Position = UDim2.fromScale(0.05, 0.35)
listLabel.Text = "Coins détectés"
listLabel.TextScaled = true
listLabel.BackgroundTransparency = 1
listLabel.TextColor3 = Color3.new(1,1,1)
listLabel.Parent = frame

local scrolling = Instance.new("ScrollingFrame")
scrolling.Size = UDim2.fromScale(0.9, 0.55)
scrolling.Position = UDim2.fromScale(0.05, 0.42)
scrolling.CanvasSize = UDim2.new(0,0,0,0)
scrolling.ScrollBarThickness = 6
scrolling.Parent = frame

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0,6)
layout.Parent = scrolling

-- ================= VISUALS =================

local highlight = Instance.new("Highlight")
highlight.FillColor = Color3.fromRGB(255, 215, 0)
highlight.OutlineColor = Color3.new(1,1,1)
highlight.Enabled = false
highlight.Parent = gui

local pathParts = {}
local function clearPath()
	for _, p in ipairs(pathParts) do p:Destroy() end
	pathParts = {}
end

local function drawPath(path)
	clearPath()
	for _, wp in ipairs(path:GetWaypoints()) do
		local p = Instance.new("Part")
		p.Size = Vector3.new(0.4,0.4,0.4)
		p.Shape = Enum.PartType.Ball
		p.Material = Enum.Material.Neon
		p.Color = Color3.fromRGB(0,170,255)
		p.Anchored = true
		p.CanCollide = false
		p.Position = wp.Position
		p.Parent = workspace
		table.insert(pathParts, p)
	end
end

-- ================= COINS =================

local function getObjectPosition(obj)
	if obj:IsA("Model") then
		if obj.PrimaryPart then return obj.PrimaryPart.Position end
		local part = obj:FindFirstChildWhichIsA("BasePart", true)
		if part then return part.Position end
		return obj:GetPivot().Position
	elseif obj:IsA("BasePart") then
		return obj.Position
	else
		return obj:GetPivot().Position
	end
end

local function refreshCoins()
	cachedCoins = {}
	for _, v in ipairs(workspace:GetDescendants()) do
		if v.Name == "Coin_Server" and not coinBlacklist[v] then
			table.insert(cachedCoins, v)
		end
	end
end

-- GUI LIST UPDATE
local function refreshCoinList()
	scrolling:ClearAllChildren()
	layout.Parent = scrolling

	local ySize = 0
	for _, coin in ipairs(cachedCoins) do
		local label = Instance.new("TextLabel")
		label.Size = UDim2.new(1, -8, 0, 24)
		label.TextScaled = true
		label.BackgroundColor3 = Color3.fromRGB(45,45,45)
		label.TextColor3 = Color3.new(1,1,1)
		label.Text = coin:GetFullName()
		label.Parent = scrolling
		ySize += 30
	end

	scrolling.CanvasSize = UDim2.new(0,0,0,ySize)
end

-- ================= PATH TARGET =================

local function getClosestCoin()
	local best, bestPath, bestDist = nil, nil, math.huge

	for _, coin in ipairs(cachedCoins) do
		local pos = getObjectPosition(coin)
		local path = PathfindingService:CreatePath()
		path:ComputeAsync(rootPart.Position, pos)

		if path.Status == Enum.PathStatus.Success then
			local dist = 0
			local wps = path:GetWaypoints()
			for i = 1, #wps-1 do
				dist += (wps[i].Position - wps[i+1].Position).Magnitude
			end
			if dist < bestDist then
				best, bestPath, bestDist = coin, path, dist
			end
		end
	end

	return best, bestPath
end

-- ================= MOVEMENT =================

local function startMovement(taskId)
	while autoWalk and taskId == currentTaskId do
		refreshCoins()
		local coin, path = getClosestCoin()
		if not coin then break end

		local targetPos = getObjectPosition(coin)
		highlight.Adornee = coin
		highlight.Enabled = true

		if moveMode == "Pathfinding" and path then
			drawPath(path)
			for _, wp in ipairs(path:GetWaypoints()) do
				if taskId ~= currentTaskId then return end
				humanoid:MoveTo(wp.Position)
				task.wait()
			end

		elseif moveMode == "Walk" then
			humanoid:MoveTo(targetPos)

		elseif moveMode == "Tween" then
			if activeTween then activeTween:Cancel() end
			local dist = (rootPart.Position - targetPos).Magnitude
			local time = dist / tweenSpeed
			activeTween = TweenService:Create(
				rootPart,
				TweenInfo.new(time, Enum.EasingStyle.Linear),
				{CFrame = CFrame.new(targetPos)}
			)
			activeTween:Play()
		end

		-- BLACKLIST
		coinBlacklist[coin] = true
		clearPath()
	end
end

-- ================= UI LOGIC =================

toggleBtn.MouseButton1Click:Connect(function()
	autoWalk = not autoWalk
	toggleBtn.Text = autoWalk and "Auto Walk : ON" or "Auto Walk : OFF"
	currentTaskId += 1
	if autoWalk then
		task.spawn(startMovement, currentTaskId)
	end
end)

modeBtn.MouseButton1Click:Connect(function()
	moveMode = (moveMode == "Pathfinding" and "Walk")
		or (moveMode == "Walk" and "Tween")
		or "Pathfinding"
	modeBtn.Text = "Mode : " .. moveMode
end)

-- SLIDER
local dragging = false
sliderBar.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
	end
end)

RunService.RenderStepped:Connect(function()
	if dragging then
		local m = player:GetMouse()
		local x = math.clamp((m.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
		sliderFill.Size = UDim2.fromScale(x,1)
		tweenSpeed = math.floor(5 + x * 45)
		sliderLabel.Text = "Tween Speed : "..tweenSpeed
	end
end)

game:GetService("UserInputService").InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- ================= CHARACTER =================

local function onChar(char)
	humanoid = char:WaitForChild("Humanoid")
	rootPart = char:WaitForChild("HumanoidRootPart")
end

if player.Character then onChar(player.Character) end
player.CharacterAdded:Connect(onChar)

-- ================= REFRESH LOOP =================
task.spawn(function()
	while true do
		task.wait(1)
		refreshCoins()
		refreshCoinList()
	end
end)
